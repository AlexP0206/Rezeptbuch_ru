<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rezeptbuch</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: #fff;
      touch-action: none;
    }

    /* Полноэкранный контейнер */
    #app {
      width: 100vw;
      height: 100vh;    /* fallback */
      height: 100dvh;   /* iOS 16+ */
      background: #000;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* viewer занимает всё доступное место */
    #viewer {
      width: 100%;
      height: 100%;
      display: grid;
      background: #000;
    }

    /* 1 или 2 страницы */
    #viewer.one { grid-template-columns: 1fr; }
    #viewer.two { grid-template-columns: 1fr 1fr; }

    /* Прячем правую страницу, когда режим one */
    #viewer.one #paneR { display: none; }
    #viewer.two #paneR { display: grid; }

    /* Каждая панель — центрирует страницу */
    .pane {
      width: 100%;
      height: 100%;
      background: #000;
      display: grid;
      place-items: center;
      overflow: hidden;
      touch-action: none;
    }

    /* Ключ: responsive-страница с пропорцией 21.5 / 26 */
    .pageWrapper {
      aspect-ratio: 21.5 / 26;

      /* Вписываемся одновременно и по ширине, и по высоте */
      width: min(100%, calc(100dvh * 0.826923)); /* 21.5/26 = 0.826923 */
      max-width: 100%;
      max-height: 100%;

      display: block;
    }

    .pageWrapper img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain; /* ✅ всегда целиком */
      background: #000;
      transform-origin: center center;
      will-change: transform;
      user-select: none;
      -webkit-user-drag: none;
      pointer-events: none; /* жесты ловит pane */
    }

    /* Индикатор страниц */
    #hud {
      position: fixed;
      left: 50%;
      bottom: 10px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.55);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 14px;
      z-index: 20;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="viewer" class="one">
      <div class="pane" id="paneL">
        <div class="pageWrapper">
          <img id="imgL" alt="">
        </div>
      </div>

      <div class="pane" id="paneR">
        <div class="pageWrapper">
          <img id="imgR" alt="">
        </div>
      </div>
    </div>
  </div>

  <div id="hud"></div>

  <script>
    // ====== ТВОИ СТРАНИЦЫ ======
    const pages = [
      "pages/page_1.jpg",
      "pages/page_2.jpg",
      "pages/page_3.jpg",
      "pages/page_4.jpg",
      "pages/page_5.jpg"
    ];

    const viewer = document.getElementById("viewer");
    const paneL  = document.getElementById("paneL");
    const paneR  = document.getElementById("paneR");
    const imgL   = document.getElementById("imgL");
    const imgR   = document.getElementById("imgR");
    const hud    = document.getElementById("hud");

    // iPad: landscape=2 страницы, portrait=1
    function isIPad() {
      return navigator.maxTouchPoints > 1 && Math.max(screen.width, screen.height) >= 1024;
    }
    function isPortrait() {
      return window.matchMedia("(orientation: portrait)").matches;
    }
    function shouldShowTwoPages() {
      return isIPad() && !isPortrait();
    }

    // Текущая страница (левая)
    let index = 0;

    // Zoom состояния для каждой панели
    const zoomState = {
      L: { scale: 1, x: 0, y: 0 },
      R: { scale: 1, x: 0, y: 0 }
    };

    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    function applyTransform(which) {
      const st = zoomState[which];
      const img = which === "L" ? imgL : imgR;
      img.style.transform = `translate(${st.x}px, ${st.y}px) scale(${st.scale})`;
    }

    function resetZoom(which) {
      zoomState[which] = { scale: 1, x: 0, y: 0 };
      applyTransform(which);
    }

    function setModeAndRender() {
      const two = shouldShowTwoPages();

      if (two) {
        viewer.classList.remove("one");
        viewer.classList.add("two");
      } else {
        viewer.classList.remove("two");
        viewer.classList.add("one");
      }

      render();
    }

    function render() {
      const two = shouldShowTwoPages();

      if (two) {
        // делаем развороты парами
        if (index % 2 !== 0) index -= 1;
        index = clamp(index, 0, pages.length - 1);

        imgL.src = pages[index] ?? "";
        imgR.src = pages[index + 1] ?? "";

        hud.textContent = `${index + 1}–${Math.min(index + 2, pages.length)} / ${pages.length}`;
      } else {
        index = clamp(index, 0, pages.length - 1);
        imgL.src = pages[index] ?? "";
        hud.textContent = `${index + 1} / ${pages.length}`;
      }

      // При смене страницы сбрасываем zoom
      resetZoom("L");
      resetZoom("R");
    }

    // ====== Свайп для листания (только если zoom=1) ======
    let swipeStartX = 0, swipeStartY = 0;

    function isZoomed() {
      return zoomState.L.scale > 1.01 || zoomState.R.scale > 1.01;
    }

    document.getElementById("app").addEventListener("touchstart", (e) => {
      if (e.touches.length !== 1) return;
      swipeStartX = e.touches[0].clientX;
      swipeStartY = e.touches[0].clientY;
    }, { passive: true });

    document.getElementById("app").addEventListener("touchend", (e) => {
      if (isZoomed()) return;

      const dx = e.changedTouches[0].clientX - swipeStartX;
      const dy = e.changedTouches[0].clientY - swipeStartY;

      // Листаем только если горизонтальный свайп заметный
      if (Math.abs(dx) < 50 || Math.abs(dx) < Math.abs(dy)) return;

      const two = shouldShowTwoPages();
      if (dx < 0) index += two ? 2 : 1;  // next
      else index -= two ? 2 : 1;         // prev

      render();
    }, { passive: true });

    // ====== Pinch-zoom + перетаскивание увеличенного ======
    function attachPinchPan(pane, which) {
      let startDist = 0;
      let startScale = 1;
      let startX = 0, startY = 0;
      let isPanning = false;

      function dist(t1, t2) {
        const dx = t2.clientX - t1.clientX;
        const dy = t2.clientY - t1.clientY;
        return Math.hypot(dx, dy);
      }

      pane.addEventListener("touchstart", (e) => {
        // если правая панель скрыта — не обрабатываем
        if (which === "R" && viewer.classList.contains("one")) return;

        if (e.touches.length === 2) {
          e.preventDefault();
          startDist = dist(e.touches[0], e.touches[1]);
          startScale = zoomState[which].scale;
          isPanning = false;
        } else if (e.touches.length === 1 && zoomState[which].scale > 1.01) {
          e.preventDefault();
          isPanning = true;
          startX = e.touches[0].clientX - zoomState[which].x;
          startY = e.touches[0].clientY - zoomState[which].y;
        }
      }, { passive: false });

      pane.addEventListener("touchmove", (e) => {
        if (which === "R" && viewer.classList.contains("one")) return;

        if (e.touches.length === 2) {
          e.preventDefault();
          const d = dist(e.touches[0], e.touches[1]);
          const factor = d / startDist;
          zoomState[which].scale = clamp(startScale * factor, 1, 4);
          applyTransform(which);
        } else if (e.touches.length === 1 && isPanning) {
          e.preventDefault();
          zoomState[which].x = e.touches[0].clientX - startX;
          zoomState[which].y = e.touches[0].clientY - startY;
          applyTransform(which);
        }
      }, { passive: false });

      pane.addEventListener("touchend", () => {
        // если вернулись к 1 — сбрасываем сдвиг
        if (zoomState[which].scale <= 1.01) resetZoom(which);
        isPanning = false;
      }, { passive: true });

      // двойной тап: быстрый зум 1 <-> 2
      let lastTap = 0;
      pane.addEventListener("touchend", (e) => {
        if (e.changedTouches.length !== 1) return;
        const now = Date.now();
        if (now - lastTap < 280) {
          if (zoomState[which].scale > 1.01) resetZoom(which);
          else { zoomState[which].scale = 2; zoomState[which].x = 0; zoomState[which].y = 0; applyTransform(which); }
          lastTap = 0;
        } else {
          lastTap = now;
        }
      }, { passive: true });
    }

    attachPinchPan(paneL, "L");
    attachPinchPan(paneR, "R");

    // Поворот/resize: iPad портрет/ландшафт переключает 1/2 страницы
    window.addEventListener("orientationchange", () => setTimeout(setModeAndRender, 150));
    window.addEventListener("resize", () => setTimeout(setModeAndRender, 150));

    // Старт
    setModeAndRender();
  </script>
</body>
</html>
